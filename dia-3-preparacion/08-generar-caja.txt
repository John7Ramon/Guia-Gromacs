# ===================================================================
# D√çA 3 - PASO 8: GENERACI√ìN AUTOMATIZADA DE CAJA DE SIMULACI√ìN
# ===================================================================

# EJECUTAR: En Ubuntu (WSL) - Directorio con sistema.gro
# Script automatizado que analiza dimensiones y genera caja √≥ptima

# Copia desde la siguiente l√≠nea
echo "üì¶ PASO 6.2: GENERACI√ìN DE CAJA"
echo "==============================="
echo "üîç Analizando dimensiones actuales..."
echo "Dimensiones en sistema.gro:"
tail -1 sistema.gro
echo ""
echo "üìè Calculando dimensiones √≥ptimas para solvataci√≥n..."
# Analizar coordenadas para determinar tama√±o m√≠nimo necesario
echo "Analizando rango de coordenadas:"
awk 'NR>2 && NF>3 {
    if(NR==3) {
        minx=maxx=$4; miny=maxy=$5; minz=maxz=$6
    } else {
        if($4<minx) minx=$4; if($4>maxx) maxx=$4
        if($5<miny) miny=$5; if($5>maxy) maxy=$5  
        if($6<minz) minz=$6; if($6>maxz) maxz=$6
    }
} END {
    rangex=maxx-minx; rangey=maxy-miny; rangez=maxz-minz
    printf "  X: %.3f a %.3f nm (rango: %.3f nm)\n", minx, maxx, rangex
    printf "  Y: %.3f a %.3f nm (rango: %.3f nm)\n", miny, maxy, rangey  
    printf "  Z: %.3f a %.3f nm (rango: %.3f nm)\n", minz, maxz, rangez
    printf "  Caja m√≠nima recomendada: %.1f x %.1f x %.1f nm\n", rangex+2, rangey+2, rangez+2
}' sistema.gro
echo ""
echo "üéØ Generando caja con dimensiones √≥ptimas..."
# Generar caja c√∫bica con distancia m√≠nima de 1.0 nm a bordes
gmx editconf -f sistema.gro -o sistema_box.gro -c -d 1.0 -bt cubic
echo ""
echo "‚úÖ Caja generada: sistema_box.gro"
echo ""
echo "üìã Verificando caja generada..."
echo "Nuevas dimensiones:"
tail -1 sistema_box.gro
echo ""
echo "üìä Comparaci√≥n antes/despu√©s:"
echo "ANTES (sistema.gro):"
echo "  $(tail -1 sistema.gro)"
echo "DESPU√âS (sistema_box.gro):"  
echo "  $(tail -1 sistema_box.gro)"
echo ""
echo "üîç Verificando integridad..."
# Verificar que el n√∫mero de √°tomos se mantuvo
orig_atoms=$(sed -n '2p' sistema.gro)
new_atoms=$(sed -n '2p' sistema_box.gro)
echo "√Åtomos originales: $orig_atoms"
echo "√Åtomos en caja: $new_atoms"
if [ "$orig_atoms" = "$new_atoms" ]; then
    echo "‚úÖ N√∫mero de √°tomos conservado"
else
    echo "‚ùå ERROR: N√∫mero de √°tomos cambi√≥"
fi
echo ""
echo "üìÑ Verificando con GROMACS..."
gmx check -f sistema_box.gro
echo ""
echo "üéØ CAJA GENERADA EXITOSAMENTE"
echo "============================"
echo "Archivo generado:"
echo "  ‚úÖ sistema_box.gro (con dimensiones √≥ptimas)"
echo ""
echo "üìã SIGUIENTE PASO: 6.3 Solvataci√≥n"
echo "gmx solvate -cp sistema_box.gro -cs spc216.gro -o sistema_solv.gro -p sistema.top"
# Copia hasta la l√≠nea anterior

# P√©galo en tu terminal con Ctrl + Shift + V y dale Enter para ejecutar

# LUEGO EJECUTA LO SIGUIENTE: 
# COMANDO PARA OPTIMIZAR LAS DIMENSIONES DE LA CAJA
gmx editconf -f sistema.gro -o sistema_box.gro -c -d 1.0 -bt cubic

# PAR√ÅMETROS:
# * `-c` = Centrar sistema en caja
# * `-d 1.0` = Distancia m√≠nima 1.0 nm a bordes
# * `-bt cubic` = Caja c√∫bica (√≥ptima para solvataci√≥n)

# SALIDA ESPERADA:
# :-) GROMACS - gmx editconf, 2025.2 (-:
# 
# Executable:   /opt/gromacs-24.4/bin/gmx
# Data prefix:  /opt/gromacs-24.4
# Working dir:  /home/jbram/gromacs_proyectos/mi_primera_simulacion/preparacion/simulacion_nueva/nuevo_intento/otramas/otra
# Command line:
#   gmx editconf -f sistema.gro -o sistema_box.gro -c -d 1.0 -bt cubic
# 
# Note that major changes are planned in future for editconf, to improve usability and utility.
# 
# Read 71 atoms
# Volume: 8000 nm^3, corresponds to roughly 3600000 electrons
# No velocities found
# system size : 1.811 0.480 0.335 (nm)
# diameter     : 1.812 (nm)
# center       : 0.009 -0.013 0.002 (nm)
# box vectors  : 40.000 20.000 10.000 (nm)
# box angles   : 90.00 90.00 90.00 (degrees)
# box volume   :8000.00 (nm^3)
# shift        : 1.896 1.919 1.904 (nm)
# new center   : 1.906 1.906 1.906 (nm)
# new box vectors : 3.812 3.812 3.812 (nm)
# new box angles  : 90.00 90.00 90.00 (degrees)
# new box volume  : 55.39 (nm^3)
# 
# Back Off! I just backed up sistema_box.gro to ./#sistema_box.gro.1#
# 
# GROMACS reminds you: "Give a Man a Fish" (Arrested Development)

# FUNCIONAMIENTO DEL SCRIPT:
# - Analiza dimensiones actuales del sistema
# - Calcula rango de coordenadas de todas las mol√©culas
# - Recomienda tama√±o m√≠nimo de caja
# - Genera caja c√∫bica centrada con margen de seguridad
# - Verifica integridad del proceso

# IMPORTANTE: 
# Estos comandos permiten crear una caja √≥ptima para el proceso 
# La distancia de 1.0 nm a bordes previene artefactos en condiciones peri√≥dicas
