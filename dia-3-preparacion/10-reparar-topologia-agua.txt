# ===================================================================
# D√çA 3 - PASO 10: REPARAR DEFINICI√ìN DE AGUA EN TOPOLOG√çA
# ===================================================================

# EJECUTAR: En Ubuntu (WSL) - Directorio con sistema.top y sistema_solv.gro
# Script para agregar definici√≥n de mol√©culas SOL faltante en topolog√≠a

# Copia desde la siguiente l√≠nea
echo "üîß REPARANDO DEFINICI√ìN SOL EN TOPOLOG√çA"
echo "========================================"
echo "üîç Buscando archivos de agua disponibles en GROMACS..."
# Buscar archivos de agua est√°ndar
water_files=$(find /opt/gromacs-24.4 -name "*spce*" -o -name "*spc*" -o -name "*tip*" 2>/dev/null | grep -i "\.itp" | head -5)
if [[ -n "$water_files" ]]; then
    echo "üìÅ Archivos de agua encontrados:"
    echo "$water_files"
else
    echo "‚ö†Ô∏è No se encontraron archivos est√°ndar, creando definici√≥n manual"
fi
echo ""
echo "üíß Agregando definici√≥n de agua SPC/E a sistema.top..."
# Crear backup de sistema.top
cp sistema.top sistema.top.backup
# Crear definici√≥n de SOL directamente en sistema.top
# Insertar despu√©s de los includes existentes y antes de [system]
awk '
/^#include "pva_polymer_clean.itp"/ {
    print $0
    print ""
    print "; Definici√≥n de agua SPC/E"
    print "[ moleculetype ]"
    print "; molname       nrexcl"
    print "SOL             2"
    print ""
    print "[ atoms ]"
    print ";   nr   type  resnr residue  atom   cgnr     charge       mass"
    print "     1     OW      1    SOL     OW      1      -0.8476   15.99940"
    print "     2     HW      1    SOL    HW1      1       0.4238    1.00800"
    print "     3     HW      1    SOL    HW2      1       0.4238    1.00800"
    print ""
    print "[ settles ]"
    print "; OW    funct   doh       dhh"
    print "1       1       0.1       0.16330"
    print ""
    print "[ exclusions ]"
    print "1       2       3"
    print "2       1       3" 
    print "3       1       2"
    print ""
    next
}
{ print }
' sistema.top > sistema.top.tmp && mv sistema.top.tmp sistema.top
echo "‚úÖ Definici√≥n SOL agregada a sistema.top"
echo ""
echo "üîç Verificando cambios..."
echo "üìÑ Secci√≥n SOL agregada:"
awk '/; Definici√≥n de agua SPC/,/; moleculetype/ { if(/^\[/ && !/moleculetype/) exit; print }' sistema.top
echo ""
echo "üìÑ Secci√≥n [molecules] final:"
awk '/\[ molecules \]/,EOF { print }' sistema.top
echo ""
echo "‚úÖ TOPOLOG√çA REPARADA"
echo "===================="
echo "Cambios realizados:"
echo "  ‚Ä¢ Backup creado: sistema.top.backup"
echo "  ‚Ä¢ Definici√≥n SOL agregada con par√°metros SPC/E"
echo "  ‚Ä¢ Cargas: OW=-0.8476, HW=+0.4238 (neutro total)"
echo "  ‚Ä¢ Configuraci√≥n SETTLES para restricciones de agua"
echo ""
echo "üß™ Probando topolog√≠a reparada..."
echo "gmx grompp -f ions.mdp -c sistema_solv.gro -p sistema.top -o ions.tpr"
# Copia hasta la l√≠nea anterior

# P√©galo en tu terminal con Ctrl + Shift + V y dale Enter para ejecutar

# FUNCIONAMIENTO DEL SCRIPT:
# - Busca archivos de agua est√°ndar en instalaci√≥n GROMACS
# - Crea backup de topolog√≠a actual (sistema.top.backup)
# - Inserta definici√≥n completa de mol√©culas SOL con modelo SPC/E
# - Verifica los cambios realizados

# DEFINICI√ìN SOL AGREGADA:
# * Cargas: OW=-0.8476, HW1=+0.4238, HW2=+0.4238 (neutro)
# * Restricciones SETTLES para geometr√≠a r√≠gida de agua
# * Exclusiones de interacciones intramoleculares

# ARCHIVOS GENERADOS:
# ‚úÖ sistema.top.backup (respaldo original)
# ‚úÖ sistema.top (con definici√≥n SOL corregida)

# IMPORTANTE: 
# Este paso soluciona el error com√∫n "Unknown molecule type SOL"
